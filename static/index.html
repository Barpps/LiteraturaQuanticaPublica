<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Frequ├¬ncias Di├írias ÔÇö Sess├úo 90 min</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="/static/css/styles.css" />
</head>
<body>
  <div id="bg" aria-hidden="true"></div>
  <div id="container">
    <canvas id="viz" aria-label="Visual de Geometria Sagrada" role="img"></canvas>
    <div id="controls" role="group" aria-label="Controles">
      <label for="moduleSel" class="sr-only">M├│dulo</label>
      <select id="moduleSel" title="Selecionar m├│dulo" aria-label="Selecionar m├│dulo">
        <option value="/static/config/modules/frequencias_diarias.json" selected>Prosperidade Consciente + Serenidade</option>
        <option value="/static/config/modules/silencio_entre_os_raios.json">O Sil├¬ncio entre os Raios</option>
        <option value="/static/config/modules/presenca_divina_acao.json">Presen├ºa Divina na A├º├úo</option>
        <option value="/static/config/modules/paz_por_do_sol.json">PAZ ÔÇö P├┤r do Sol da Integra├º├úo</option>
      </select>
      <label for="modeSel" class="sr-only">Modo de Batimento</label>
      <select id="modeSel" title="Modo de Batimento" aria-label="Modo de Batimento">
        <option value="auto" selected>Auto</option>
        <option value="binaural">Fones (Binaural)</option>
        <option value="iso">Ambiente (Isocr├┤nico)</option>
      </select>
      <button class="btn-ringlight" id="play" aria-label="Play" onclick="window.__ringPlay && window.__ringPlay()">PLAY</button>
      <button class="btn-ringlight" id="stop" aria-label="Stop" onclick="window.__ringStop && window.__ringStop()">STOP</button>
      <button class="btn-ringlight" id="prevPhase" aria-label="Retroceder Fase" onclick="window.__ringPrev && window.__ringPrev()">Retroceder Fase</button>
      <button class="btn-ringlight" id="nextPhase" aria-label="Avan├ºar Fase">Avan├ºar Fase</button>
      <button class="btn-ringlight" id="exitBtn" aria-label="Sair" onclick="window.__ringExit && window.__ringExit()">Sair</button>
      <span id="timer" aria-live="polite">00:00 / 90:00</span>
      <span id="bwStatus" aria-live="polite" style="color:#FFE773;">Isocr├┤nico ativo</span>
      <span id="phase" aria-live="polite">Pronto</span>
    </div>
    <button class="btn-ringlight" id="fsBtn" aria-label="Tela Cheia" title="Tela Cheia">Tela Cheia</button>
  </div>

  <!-- Modal: Intencao -->
  <div id="modal-intent" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="intent-title">
    <div class="modal-content">
      <h2 id="intent-title">Inten├º├úo Vibracional Declarada</h2>
      <p id="intent-text" class="modal-text">ÔÇ£Este espa├ºo visual-sonoro ├® um campo de coer├¬ncia.<br>
      A luz pulsa no ritmo do cora├º├úo.<br>
      O som guia o tempo.<br>
      Eu Sou o centro sereno de abund├óncia consciente.ÔÇØ</p>
      <div class="modal-actions">
        <button class="btn-ringlight" id="intent-ok" autofocus>OK</button>
      </div>
    </div>
  </div>

  <!-- Modal: Selamento -->
  <div id="modal-seal" class="modal hidden" role="dialog" aria-modal="true" aria-labelledby="seal-title">
    <div class="modal-content">
      <h2 id="seal-title">Selamento do Campo</h2>
      <p id="seal-text" class="modal-text">ÔÇ£Antes de encerrar, eu selo o trabalho de hoje com gratid├úo e ordem divina.<br>
      Levo comigo a calma, a clareza e a prosperidade consciente.ÔÇØ</p>
      <div class="modal-actions">
        <button class="btn-ringlight" id="seal-ok" autofocus>OK</button>
        <button class="btn-ringlight" id="seal-cancel">Cancelar</button>
      </div>
    </div>
  </div>

  <script type="module">
    import { SessionAudio } from '/static/js/audioEngine.js';
    import { Visuals } from '/static/js/visuals.js';

    const playBtn = document.getElementById('play');
    const stopBtn = document.getElementById('stop');
    const timerEl = document.getElementById('timer');
    const phaseEl = document.getElementById('phase');
    const prevPhaseBtn = document.getElementById('prevPhase');
    const nextPhaseBtn = document.getElementById('nextPhase');
    const exitBtn = document.getElementById('exitBtn');
    const modalIntent = document.getElementById('modal-intent');
    const modalSeal = document.getElementById('modal-seal');
    const intentOk = document.getElementById('intent-ok');
    const sealOk = document.getElementById('seal-ok');
    const sealCancel = document.getElementById('seal-cancel');
    const intentTitle = document.getElementById('intent-title');
    const intentText = document.getElementById('intent-text');
    const sealTitle = document.getElementById('seal-title');
    const sealText = document.getElementById('seal-text');
    const canvas = document.getElementById('viz');
    const bwStatus = document.getElementById('bwStatus');
    
    let configUrl = '/static/config/modules/frequencias_diarias.json';
    let audio = new SessionAudio(configUrl);
    const visuals = new Visuals(canvas);

    let timerInterval = null;

    function formatTime(sec) {
      const m = Math.floor(sec / 60);
      const s = Math.floor(sec % 60);
      return `${String(m).padStart(2,'0')}:${String(s).padStart(2,'0')}`;
    }

    async function init() {
      const cfg = await audio.init();
      // Atualiza textos de popups por m├│dulo (se dispon├¡vel)
      if (cfg.popups && cfg.popups.intent) {
        intentTitle.textContent = cfg.popups.intent.title || intentTitle.textContent;
        intentText.innerHTML = cfg.popups.intent.message || intentText.innerHTML;
      }
      if (cfg.popups && cfg.popups.seal) {
        sealTitle.textContent = cfg.popups.seal.title || sealTitle.textContent;
        sealText.innerHTML = cfg.popups.seal.message || sealText.innerHTML;
      }
      visuals.init({
        breathingBpm: cfg.breathingBpm,
        rotationRadPerSec: cfg.rotationRadPerSec,
        brightnessMax: cfg.brightnessMax,
        petals: cfg.visual?.flowerPetals,
        flowerOpacity: cfg.visual?.flowerOpacity,
        palette: cfg.visual?.palette,
        centralSphere: cfg.visual?.centralSphere,
        geometry: cfg.visual?.geometry,
        maxMicropulsesPerCycle: cfg.visual?.maxMicropulsesPerCycle
      });
      // Atualiza fundo radial via CSS vars se fornecido
      if (cfg.visual?.palette?.bg1) {
        const p = cfg.visual.palette;
        document.body.style.setProperty('--bg1', p.bg1);
        document.body.style.setProperty('--bg2', p.bg2 || p.bg1);
        document.body.style.setProperty('--bg3', p.bg3 || p.bg2 || p.bg1);
      }
      visuals.setAudioTimeProvider(() => audio.currentTime());
      visuals.animate();
    }

    let intentionShown = false;

    async function enterFullscreenIfPossible() {
      const docEl = document.documentElement;
      if (docEl.requestFullscreen) {
        try { await docEl.requestFullscreen(); } catch {}
      }
    }

    function showModal(el) { el.classList.remove('hidden'); }
    function hideModal(el) { el.classList.add('hidden'); }

    window.__ringPlay = async function(){ if (audio && audio._started && audio.isPaused && audio.isPaused()){ try{ await audio.resume(); }catch(e){} visuals.setActive(true); return; } if (!intentionShown){ showModal(modalIntent); intentOk.focus(); return; } try { await audio.start(); } catch(e){} visuals.setActive(true); if (window.timerInterval) clearInterval(window.timerInterval); window.timerInterval = setInterval(() => { try{ const t = audio.currentTime(); timerEl.textContent = ${formatTime(t)} / 90:00; phaseEl.textContent = audio.currentPhaseName(); visuals.setPhase(audio.currentPhaseIndex()); if (audio.activeBeatType) { const mode = audio.activeBeatType(); bwStatus.textContent = mode === 'binaural' ? 'Binaural ativo' : 'Isocrônico ativo'; } }catch(e){} }, 500); }; playBtn.addEventListener('click', window.__ringPlay);
        visuals.setActive(true);
        return;
      }
      if (!intentionShown) {
        showModal(modalIntent);
        intentOk.focus();
        return;
      }
      await audio.start();
      visuals.setActive(true);
      if (timerInterval) clearInterval(timerInterval);
      timerInterval = setInterval(() => {
        const t = audio.currentTime();
        timerEl.textContent = `${formatTime(t)} / 90:00`;
        phaseEl.textContent = audio.currentPhaseName();
        visuals.setPhase(audio.currentPhaseIndex());
        if (audio.activeBeatType) {
          const mode = audio.activeBeatType();
          bwStatus.textContent = mode === 'binaural' ? 'Binaural ativo' : 'Isocr├┤nico ativo';
        }
      }, 500);
    });

    intentOk.addEventListener('click', async () => {
      hideModal(modalIntent);
      intentionShown = true;
      await enterFullscreenIfPossible();
      try {
        if (screen.orientation && screen.orientation.lock && window.innerHeight > window.innerWidth) {
          await screen.orientation.lock('landscape');
        }
      } catch {}
      playBtn.click();
    });

    // Enter key closes Intencao modal
    modalIntent.addEventListener('keydown', (e) => {
      if (e.key === 'Enter') { intentOk.click(); }
    });

    window.__ringStop = async function(){ if (audio && audio.pause) await audio.pause(); visuals.setActive(false); }; stopBtn.addEventListener('click', window.__ringStop);
      visuals.setActive(false);
    });

    // Fase navigation
    window.__ringPrev = function(){ const idx = Math.max(0, audio.currentPhaseIndex() - 1); audio.setPhaseIndex(idx, 1.0); visuals.setPhase(idx); phaseEl.textContent = audio.currentPhaseName(); }; prevPhaseBtn.addEventListener('click', window.__ringPrev);
      audio.setPhaseIndex(idx, 1.0);
      visuals.setPhase(idx);
      phaseEl.textContent = audio.currentPhaseName();
    });

    window.__ringNext = function(){ const idx = Math.min(3, audio.currentPhaseIndex() + 1); audio.setPhaseIndex(idx, 1.0); visuals.setPhase(idx); phaseEl.textContent = audio.currentPhaseName(); }; nextPhaseBtn.addEventListener('click', window.__ringNext);
      audio.setPhaseIndex(idx, 1.0);
      visuals.setPhase(idx);
      phaseEl.textContent = audio.currentPhaseName();
    });

    // Exit button -> Seal modal
    window.__ringExit = function(){ showModal(modalSeal); sealOk.focus(); }; exitBtn.addEventListener('click', window.__ringExit);
      sealOk.focus();
    });

    sealOk.addEventListener('click', async () => {
      await audio.fadeOutAndStop(1.5);
      visuals.setActive(false);
      if (document.fullscreenElement) {
        try { await document.exitFullscreen(); } catch {}
      }
      hideModal(modalSeal);
      if (timerInterval) clearInterval(timerInterval);
      timerEl.textContent = '00:00 / 90:00';
      phaseEl.textContent = 'Pronto';
    });

    sealCancel.addEventListener('click', () => {
      hideModal(modalSeal);
    });

    modalSeal.addEventListener('keydown', (e) => {
      if (e.key === 'Escape') { sealCancel.click(); }
      if (e.key === 'Enter') { sealOk.click(); }
    });

    // Fullscreen state handlers
    const controls = document.getElementById('controls');
    let hideTimer = null;
    function scheduleHideControls() {
      if (!document.fullscreenElement) return;
      controls.classList.remove('hidden');
      if (hideTimer) clearTimeout(hideTimer);
      hideTimer = setTimeout(() => controls.classList.add('hidden'), 3000);
    }

    function onFsChange() {
      const fs = !!document.fullscreenElement;
      document.body.classList.toggle('is-fullscreen', fs);
      if (fs) {
        controls.classList.remove('hidden');
        scheduleHideControls();
      } else {
        controls.classList.remove('hidden');
      }
    }
    document.addEventListener('fullscreenchange', onFsChange);

    document.addEventListener('mousemove', () => scheduleHideControls());
    document.addEventListener('touchstart', () => scheduleHideControls());

    // Fallback de binaural -> isocr├┤nico quando a aba perde foco
    document.addEventListener('visibilitychange', () => {
      if (document.visibilityState === 'hidden' && audio && audio.fallbackToIso) {
        audio.fallbackToIso();
      }
    });

    // Re-entry fullscreen button
    const fsBtn = document.getElementById('fsBtn');
    fsBtn.addEventListener('click', () => enterFullscreenIfPossible());

    // Troca de m├│dulo
    const moduleSel = document.getElementById('moduleSel');
    moduleSel.addEventListener('change', async () => {
      const wasPlaying = audio && audio._started;
      if (audio) await audio.fadeOutAndStop(0.8);
      configUrl = moduleSel.value;
      audio = new SessionAudio(configUrl);
      const cfg = await audio.init();
      if (cfg.popups && cfg.popups.intent) {
        intentTitle.textContent = cfg.popups.intent.title || intentTitle.textContent;
        intentText.innerHTML = cfg.popups.intent.message || intentText.innerHTML;
      }
      if (cfg.popups && cfg.popups.seal) {
        sealTitle.textContent = cfg.popups.seal.title || sealTitle.textContent;
        sealText.innerHTML = cfg.popups.seal.message || sealText.innerHTML;
      }
      // Atualiza par├ómetros de visuals mantendo anima├º├úo
      visuals.init({
        breathingBpm: cfg.breathingBpm,
        rotationRadPerSec: cfg.rotationRadPerSec,
        brightnessMax: cfg.brightnessMax,
        petals: cfg.visual?.flowerPetals,
        flowerOpacity: cfg.visual?.flowerOpacity,
        palette: cfg.visual?.palette,
        centralSphere: cfg.visual?.centralSphere,
        geometry: cfg.visual?.geometry,
        maxMicropulsesPerCycle: cfg.visual?.maxMicropulsesPerCycle
      });
      visuals.setAudioTimeProvider(() => audio.currentTime());
      if (cfg.visual?.palette?.bg1) {
        const p = cfg.visual.palette;
        document.body.style.setProperty('--bg1', p.bg1);
        document.body.style.setProperty('--bg2', p.bg2 || p.bg1);
        document.body.style.setProperty('--bg3', p.bg3 || p.bg2 || p.bg1);
      }
      if (wasPlaying) playBtn.click();
    });

    // Troca de modo (Auto / Binaural / Isocr├┤nico)
    const modeSel = document.getElementById('modeSel');
    modeSel.addEventListener('change', async () => {
      if (audio && audio.setBeatMode) {
        audio.setBeatMode(modeSel.value);
      }
    });

    init();
  </script>
</body>
</html>


